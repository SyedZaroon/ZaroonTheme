{% comment %}
  Section: Main Collection (AJAX filters)
  - Sidebar filters (Search & Discovery)
  - Sort, grid toggle, pagination
  - Active filter chips + Clear all
  - AJAX updates + URL pushState
{% endcomment %}

{{ 'main-collection.css' | asset_url | stylesheet_tag}}

{%- assign current_sort = collection.sort_by | default: collection.default_sort_by -%}
{%- assign product_per_page = section.settings.products_per_page | default: 24 -%}
{%- assign cols_desktop = section.settings.columns_desktop | default: 4 -%}
{%- assign cols_mobile = section.settings.columns_mobile | default: 2 -%}
{%- assign grid_gap = section.settings.grid_gap | default: 16 -%}
{%- assign filters = collection.filters | default: search.filters -%}

<section
  id="section-{{ section.id }}"
  class="main-collection"
  data-section-id="{{ section.id }}"
  style="
    --sidebar-width: {{ section.settings.sidebar_width }}px;
    --grid-gap: {{ grid_gap }}px;
    --columns-desktop: {{ cols_desktop }};
    --columns-mobile: {{ cols_mobile }};
  "
>
  <header class="collection-header space-section">
    <h1 class="collection-title">{{ collection.title }}</h1>
  </header>

  <div class="collection-page">
    <!-- ===== Sidebar ===== -->
    <aside class="main-collection__sidebar js-collection-sidebar" aria-label="Collection filters">
      {% if section.settings.filter %}
        {% if filters and filters.size > 0 %}
          <div class="filters">
            {% for filter in filters %}
              {% if filter.values.size > 0 %}
                <div class="filter-group">
                  <h4 class="filter-group__title">{{ filter.label | default: filter.title }}</h4>
                  <ul class="filter-values">
                    {% for value in filter.values %}
                      {%- assign is_active = value.active -%}
                      <li class="filter-values__item">
                        <a
                          class="filter-value{% if is_active %} is-active{% endif %}"
                          href="{% if is_active %}{{ value.url_to_remove }}{% else %}{{ value.url }}{% endif %}"
                          aria-pressed="{{ is_active }}"
                        >
                          <span class="box" aria-hidden="true"></span>
                          <span class="label">{{ value.label | default: value.title }}</span>
                          {% if value.count > 0 %}
                            <span class="count">({{ value.count }})</span>
                          {% endif %}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>

                  {%- if filter.active_values.size > 0 -%}
                    <a class="filter-clear" href="{{ filter.url_to_remove }}">Clear {{ filter.label }}</a>
                  {%- endif -%}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <p class="filters-empty">No filters available.</p>
        {% endif %}
      {% endif %}
    </aside>

    <!-- ===== Content ===== -->
    <div class="main-collection__content">

      <div class="product-filter js-collection-toolbar">
        {% if section.settings.show_total_count %}
          <p class="collection-count">{{ collection.products_count }} products</p>
        {% endif %}

        {% if section.settings.show_sort %}
          <form class="collection-toolbar__sort js-collection-sort" method="get" action="{{ collection.url }}">
            <label for="SortBy-{{ section.id }}" class="label">Sort</label>

            {%- comment -%}
            We’ll serialize existing params via JS; hidden inputs not required for AJAX path.
            {%- endcomment -%}

            <select id="SortBy-{{ section.id }}" name="sort_by">
              {%- assign sorts = 'manual|Featured,best-selling|Best selling,title-ascending|Alphabetically, A–Z,title-descending|Alphabetically, Z–A,price-ascending|Price, low to high,price-descending|Price, high to low,created-descending|Date, new to old,created-ascending|Date, old to new' | split: ',' -%}
              {%- for s in sorts -%}
                {%- assign pair = s | split: '|' -%}
                <option value="{{ pair[0] }}" {% if current_sort == pair[0] %}selected{% endif %}>{{ pair[1] }}</option>
              {%- endfor -%}
            </select>
            <noscript><button type="submit">Apply</button></noscript>
          </form>
        {% endif %}

        {% if section.settings.show_grid_toggle %}
          {%- assign gs = request.params.grid | default: cols_desktop -%}
          <div class="collection-toolbar__grid-toggle" role="group" aria-label="Grid columns">
            {%- for n in (2..5) -%}
              <a
                class="grid-toggle__btn {%- if gs == n -%}is-active{%- endif -%}"
                href="{{ collection.url }}?grid={{ n }}"
              >
                {{ n }}
              </a>
            {%- endfor -%}
          </div>
        {% endif %}
      </div>

      {%- assign has_active = false -%}
      {%- for f in filters -%}{% if f.active_values.size > 0 %}{% assign has_active = true %}{% break %}{% endif %}{% endfor %}

      <div class="active-filters js-active-filters" role="region" aria-label="Active filters">
        {% if has_active %}
          <strong>Filters:</strong>
          <div class="chips">
            {%- for f in filters -%}
              {%- for v in f.active_values -%}
                <a class="chip chip--active" href="{{ v.url_to_remove }}">
                  {{ f.label }}: {{ v.label }} <span aria-hidden="true">×</span>
                </a>
              {%- endfor -%}
            {%- endfor -%}
            <a class="chip chip--clear" href="{{ collection.url }}">Clear all</a>
          </div>
        {% endif %}
      </div>

      {% paginate collection.products by product_per_page %}
        <div
          class="product-grid js-collection-grid"
          style="--desktop-grid: {{ request.params.grid | default: cols_desktop }}; --grid-gap: {{ grid_gap }}px"
        >
          {% for product in collection.products %}
            <div class="product-item">
              <a href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 400 }}"
                    srcset="
                      {{ product.featured_image | image_url: width: 200 }} 200w,
                      {{ product.featured_image | image_url: width: 300 }} 300w,
                      {{ product.featured_image | image_url: width: 400 }} 400w
                    "
                    sizes="(min-width: 768px) 220px, 45vw"
                    loading="lazy"
                    alt="{{ product.title | escape }}"
                  >
                {% else %}
                  <div class="placeholder" role="img" aria-label="No image">No Image</div>
                {% endif %}
                <h3>{{ product.title }}</h3>
                <p class="price">
                  {%- if product.price_min != product.price_max -%}
                    From {{ product.price_min | money }}
                  {%- else -%}
                    {{ product.price | money }}
                  {%- endif -%}
                  {%- if product.compare_at_price_max > product.price_max -%}
                    <span class="compare">{{ product.compare_at_price_max | money }}</span>
                  {%- endif -%}
                </p>
              </a>
            </div>
          {% endfor %}
        </div>

        <nav class="pagination js-collection-pagination" role="navigation" aria-label="Pagination">
          {% if paginate.previous %}
            <a class="page-link prev" href="{{ paginate.previous.url }}">← Previous</a>
          {% endif %}

          {% for part in paginate.parts %}
            {% if part.is_link %}
              <a class="page-link" href="{{ part.url }}">{{ part.title }}</a>
            {% else %}
              <span class="page-link {% if part.title == paginate.current_page %}active{% endif %}">
                {{ part.title }}
              </span>
            {% endif %}
          {% endfor %}

          {% if paginate.next %}
            <a class="page-link next" href="{{ paginate.next.url }}">Next →</a>
          {% endif %}
        </nav>
      {% endpaginate %}
    </div>
  </div>
</section>



{% schema %}
{
  "name": "Main Collection (AJAX)",
  "enabled_on": { "templates": ["collection"] },
  "settings": [
    { "type": "header", "content": "Filter Setting" },
    {
      "type": "checkbox",
      "id": "filter",
      "label": "Enable filters (Search & Discovery)",
      "default": true,
      "info": "Manage filter options in the Search & Discovery app"
    },
    {
      "type": "range",
      "id": "sidebar_width",
      "label": "Sidebar width (desktop)",
      "min": 200, "max": 420, "step": 10, "unit": "px",
      "default": 280
    },

    { "type": "header", "content": "Products Grid" },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 6, "max": 60, "step": 6, "default": 24
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Grid columns (desktop)",
      "min": 2, "max": 5, "step": 1, "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Grid columns (mobile)",
      "min": 1, "max": 3, "step": 1, "default": 2
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid gap",
      "min": 0, "max": 40, "step": 2, "unit": "px",
      "default": 16
    },

    { "type": "header", "content": "Toolbar" },
    {
      "type": "checkbox",
      "id": "show_total_count",
      "label": "Show total products count",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sort",
      "label": "Show sort dropdown",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_grid_toggle",
      "label": "Show grid toggle (desktop)",
      "default": true
    }
  ],
  "presets": [{ "name": "Main Collection (AJAX)" }]
}
{% endschema %}
